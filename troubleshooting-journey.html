<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Management Budget Estimator - Troubleshooting Journey</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
            --warning: #d97706;
            --bg-light: #f8fafc;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.95;
        }
        
        .meta-info {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            font-size: 0.95rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .content {
            padding: 2rem;
        }
        
        .summary {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--success);
        }
        
        .summary h2 {
            color: var(--success);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        .error-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }
        
        .error-item:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .error-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        
        .error-number {
            background: var(--error);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .error-title {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .error-tag {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 1rem;
        }
        
        .error-content {
            padding: 1.5rem;
        }
        
        .error-section {
            margin-bottom: 1.5rem;
        }
        
        .error-section h4 {
            color: var(--text);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .icon {
            width: 20px;
            height: 20px;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--error);
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        
        .solution {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .code-block.diff-remove {
            background: #450a0a;
            color: #fca5a5;
        }
        
        .code-block.diff-add {
            background: #052e16;
            color: #86efac;
        }
        
        .lessons-learned {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .lessons-learned h2 {
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        .lesson {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .lesson strong {
            color: #fbbf24;
        }
        
        .setup-guide {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .setup-guide h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
        }
        
        .step {
            display: flex;
            margin-bottom: 1.5rem;
        }
        
        .step-number {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content h4 {
            margin-bottom: 0.5rem;
        }
        
        .command {
            background: #1e293b;
            color: #10b981;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin: 0.5rem 0;
            display: inline-block;
        }
        
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            border-top: 1px solid var(--border);
        }
        
        .success-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            border-radius: 12px;
        }
        
        .success-banner h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üó∫Ô∏è Place Management Budget Estimator</h1>
            <p class="subtitle">Troubleshooting Journey & Resolution Guide</p>
            <div class="meta-info">
                <div class="meta-item">
                    üìÖ Date: November 2024
                </div>
                <div class="meta-item">
                    ‚ö° Stack: React + TypeScript + BigQuery + Netlify
                </div>
                <div class="meta-item">
                    üîß Resolved: 7 Critical Issues
                </div>
            </div>
        </header>
        
        <div class="content">
            <div class="summary">
                <h2>üìä Journey Summary</h2>
                <p>This document chronicles the debugging journey of setting up the Place Management Budget Estimator application, from initial error to full functionality. Each error taught us something valuable about the architecture and configuration requirements.</p>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value">7</div>
                        <div class="stat-label">Errors Resolved</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">3</div>
                        <div class="stat-label">Files Modified</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">2</div>
                        <div class="stat-label">Helper Scripts Created</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">100%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
            </div>
            
            <h2 style="margin: 2rem 0 1.5rem; color: var(--primary);">üî• Errors Encountered & Solutions</h2>
            
            <!-- Error 1 -->
            <div class="error-item">
                <div class="error-header">
                    <div class="error-number">1</div>
                    <div class="error-title">Missing Function: placesWithinPolygonSQL</div>
                    <span class="error-tag">TypeError</span>
                </div>
                <div class="error-content">
                    <div class="error-section">
                        <h4>üî¥ Error Message</h4>
                        <div class="error-message">Uncaught ReferenceError: placesWithinPolygonSQL is not defined at line 209</div>
                    </div>
                    <div class="error-section">
                        <h4>üîç Root Cause</h4>
                        <p>The code was calling a non-existent function <code>placesWithinPolygonSQL()</code>. The function was never defined in the codebase.</p>
                    </div>
                    <div class="error-section">
                        <h4>‚úÖ Solution</h4>
                        <div class="solution">
                            <p>Replaced the missing function call with inline SQL query construction directly in the <code>fetchPlaces</code> function.</p>
                        </div>
                        <div class="code-block">const sql = `
  WITH poly AS (
    SELECT ST_GEOGFROMGEOJSON(@polygon_geojson) AS g
  )
  SELECT id, categories, names, geometry
  FROM \`${placesTable}\`, poly
  WHERE ST_INTERSECTS(geometry, poly.g)
  LIMIT 10000
`;</div>
                    </div>
                </div>
            </div>
            
            <!-- Error 2 -->
            <div class="error-item">
                <div class="error-header">
                    <div class="error-number">2</div>
                    <div class="error-title">404 Not Found - API Endpoint Missing</div>
                    <span class="error-tag">Network Error</span>
                </div>
                <div class="error-content">
                    <div class="error-section">
                        <h4>üî¥ Error Message</h4>
                        <div class="error-message">POST /api/sql 404 (Not Found)</div>
                    </div>
                    <div class="error-section">
                        <h4>üîç Root Cause</h4>
                        <p>Running <code>npm run dev</code> only starts the Vite frontend server. The Netlify Functions (serverless backend) were not running, so the API endpoints didn't exist.</p>
                    </div>
                    <div class="error-section">
                        <h4>‚úÖ Solution</h4>
                        <div class="solution">
                            <p>Use <code>netlify dev</code> instead of <code>npm run dev</code> to run both frontend and serverless functions together.</p>
                        </div>
                        <div class="code-block"># Instead of:
npm run dev  # ‚ùå Only runs frontend

# Use:
netlify dev  # ‚úÖ Runs frontend + backend functions</div>
                    </div>
                </div>
            </div>
            
            <!-- Error 3 -->
            <div class="error-item">
                <div class="error-header">
                    <div class="error-number">3</div>
                    <div class="error-title">Service Account JSON: DECODER routines::unsupported</div>
                    <span class="error-tag">Authentication Error</span>
                </div>
                <div class="error-content">
                    <div class="error-section">
                        <h4>üî¥ Error Message</h4>
                        <div class="error-message">error:1E08010C:DECODER routines::unsupported</div>
                    </div>
                    <div class="error-section">
                        <h4>üîç Root Cause</h4>
                        <p>The Google Service Account private key in the .env file had escaped newlines (<code>\\n</code>) instead of actual newline characters. This prevented proper SSL key parsing.</p>
                    </div>
                    <div class="error-section">
                        <h4>‚úÖ Solution</h4>
                        <div class="solution">
                            <p>Created a script to automatically fix the private key format by converting escaped newlines to actual newlines.</p>
                        </div>
                        <div class="code-block">// fix-service-account.js
const saJson = JSON.parse(saJsonString);
if (saJson.private_key.includes('\\n')) {
  saJson.private_key = saJson.private_key.replace(/\\n/g, '\n');
}</div>
                    </div>
                </div>
            </div>
            
            <!-- Error 4 -->
            <div class="error-item">
                <div class="error-header">
                    <div class="error-number">4</div>
                    <div class="error-title">BigQuery Parameter Type Mismatch</div>
                    <span class="error-tag">SQL Error</span>
                </div>
                <div class="error-content">
                    <div class="error-section">
                        <h4>üî¥ Error Message</h4>
                        <div class="error-message">Unparseable query parameter `polygon_geojson` in type `TYPE_GEOGRAPHY`, Unexpected '{' at position 0</div>
                    </div>
                    <div class="error-section">
                        <h4>üîç Root Cause</h4>
                        <p>The SQL function was incorrectly passing the GeoJSON parameter as type GEOGRAPHY instead of STRING. BigQuery's <code>ST_GEOGFROMGEOJSON</code> expects a STRING input.</p>
                    </div>
                    <div class="error-section">
                        <h4>‚úÖ Solution</h4>
                        <div class="solution">
                            <p>Changed parameter binding to always use STRING type for GeoJSON data.</p>
                        </div>
                        <div class="code-block diff-remove">// ‚ùå Before:
if (name === 'polygon_geojson') {
  bqParams.push({ name, parameterType: { type: 'GEOGRAPHY' }, ... });
}</div>
                        <div class="code-block diff-add">// ‚úÖ After:
// All string parameters including polygon_geojson
bqParams.push({ name, parameterType: { type: 'STRING' }, ... });</div>
                    </div>
                </div>
            </div>
            
            <!-- Error 5 -->
            <div class="error-item">
                <div class="error-header">
                    <div class="error-number">5</div>
                    <div class="error-title">Table Must Be Qualified with Dataset</div>
                    <span class="error-tag">BigQuery Error</span>
                </div>
                <div class="error-content">
                    <div class="error-section">
                        <h4>üî¥ Error Message</h4>
                        <div class="error-message">Table "carto_overture_geography_glo_places_v3" must be qualified with a dataset (e.g. dataset.table)</div>
                    </div>
                    <div class="error-section">
                        <h4>üîç Root Cause</h4>
                        <p>BigQuery requires fully qualified table names in the format <code>project.dataset.table</code> or at minimum <code>dataset.table</code>.</p>
                    </div>
                    <div class="error-section">
                        <h4>‚úÖ Solution</h4>
                        <div class="solution">
                            <p>Updated .env file with fully qualified table names after discovering the actual dataset structure.</p>
                        </div>
                        <div class="code-block diff-remove"># ‚ùå Before:
VITE_PLACES_TABLE=carto_overture_geography_glo_places_v3</div>
                        <div class="code-block diff-add"># ‚úÖ After:
VITE_PLACES_TABLE=ginkgo-map-data.overture_na.place</div>
                    </div>
                </div>
            </div>
            
            <!-- Error 6 -->
            <div class="error-item">
                <div class="error-header">
                    <div class="error-number">6</div>
                    <div class="error-title">SAFE_OFFSET Is Not a Function</div>
                    <span class="error-tag">SQL Syntax Error</span>
                </div>
                <div class="error-content">
                    <div class="error-section">
                        <h4>üî¥ Error Message</h4>
                        <div class="error-message">SAFE_OFFSET is not a function. It can only be used for array element access using array[SAFE_OFFSET(position)]</div>
                    </div>
                    <div class="error-section">
                        <h4>üîç Root Cause</h4>
                        <p>Incorrect BigQuery syntax. <code>SAFE_OFFSET</code> must be used within array brackets, not as a standalone function.</p>
                    </div>
                    <div class="error-section">
                        <h4>‚úÖ Solution</h4>
                        <div class="solution">
                            <p>Fixed the syntax to use proper array indexing notation.</p>
                        </div>
                        <div class="code-block diff-remove">-- ‚ùå Before:
SAFE_OFFSET(categories, 0) AS category</div>
                        <div class="code-block diff-add">-- ‚úÖ After:
categories[SAFE_OFFSET(0)] AS category</div>
                    </div>
                </div>
            </div>
            
            <!-- Error 7 -->
            <div class="error-item">
                <div class="error-header">
                    <div class="error-number">7</div>
                    <div class="error-title">JSON_VALUE Type Mismatch with STRUCT</div>
                    <span class="error-tag">Data Type Error</span>
                </div>
                <div class="error-content">
                    <div class="error-section">
                        <h4>üî¥ Error Message</h4>
                        <div class="error-message">No matching signature for function JSON_VALUE. Unable to coerce type STRUCT to expected type STRING/JSON</div>
                    </div>
                    <div class="error-section">
                        <h4>üîç Root Cause</h4>
                        <p>The Overture data schema uses STRUCT types, not JSON strings. The <code>names</code> field is a structured object, not a JSON string.</p>
                    </div>
                    <div class="error-section">
                        <h4>‚úÖ Solution</h4>
                        <div class="solution">
                            <p>Access STRUCT fields directly using dot notation instead of JSON parsing.</p>
                        </div>
                        <div class="code-block diff-remove">-- ‚ùå Before:
JSON_VALUE(names, '$.primary') AS name</div>
                        <div class="code-block diff-add">-- ‚úÖ After:
names.primary AS name</div>
                    </div>
                </div>
            </div>
            
            <div class="success-banner">
                <h3>üéâ Success!</h3>
                <p>All errors resolved. Application is now fully functional with BigQuery integration!</p>
            </div>
            
            <div class="setup-guide">
                <h2>üöÄ Quick Setup Guide (Post-Resolution)</h2>
                
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Install Dependencies</h4>
                        <div class="command">npm install</div>
                        <div class="command">npm install -g netlify-cli</div>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Configure Environment</h4>
                        <p>Create <code>.env</code> file with:</p>
                        <ul>
                            <li>Google Service Account JSON (ensure proper newline formatting)</li>
                            <li>GCP Project ID</li>
                            <li>BigQuery table names (fully qualified: project.dataset.table)</li>
                            <li>Mapbox credentials</li>
                        </ul>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Run Development Server</h4>
                        <div class="command">netlify dev</div>
                        <p>‚ö†Ô∏è Important: Use <code>netlify dev</code>, NOT <code>npm run dev</code></p>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>Access Application</h4>
                        <p>Open browser to <code>http://localhost:8888</code></p>
                        <p>Draw polygons on the map and fetch places!</p>
                    </div>
                </div>
            </div>
            
            <div class="lessons-learned">
                <h2>üí° Key Lessons Learned</h2>
                
                <div class="lesson">
                    <strong>Architecture Understanding:</strong> The application has a two-tier architecture - frontend (Vite) and backend (Netlify Functions). Both must run together for full functionality.
                </div>
                
                <div class="lesson">
                    <strong>BigQuery Specifics:</strong> Always use fully qualified table names and understand the difference between STRUCT fields and JSON strings in your data schema.
                </div>
                
                <div class="lesson">
                    <strong>Environment Variables:</strong> Service Account JSON formatting is critical - escaped newlines vs actual newlines can break authentication.
                </div>
                
                <div class="lesson">
                    <strong>SQL Syntax:</strong> BigQuery has specific syntax requirements (e.g., SAFE_OFFSET usage, parameter types) that differ from standard SQL.
                </div>
                
                <div class="lesson">
                    <strong>Development vs Production:</strong> Understanding the difference between development servers (<code>npm run dev</code> vs <code>netlify dev</code>) is crucial for debugging.
                </div>
                
                <div class="lesson">
                    <strong>Systematic Debugging:</strong> Adding console.logs and creating helper scripts for diagnostics speeds up troubleshooting significantly.
                </div>
            </div>
        </div>
        
        <footer>
            <p>üìù Documentation generated after successful troubleshooting session</p>
            <p>üõ†Ô∏è Built with React, TypeScript, BigQuery, and Netlify Functions</p>
            <p style="margin-top: 1rem; font-size: 0.9rem;">This journey demonstrates the importance of systematic debugging and understanding your full stack architecture.</p>
        </footer>
    </div>
</body>
</html>